import { Meta } from '@storybook/addon-docs/blocks';
import locationSchema from './assets/techStackSummary/locationSchema.png'; import {
  Error,
  Text,
  Underlined
} from '../components/Typography'; import { colors } from '../assets/theme'; import Card from '../components/Card';

<Meta title="Docs/backendUnitTest" />

# Unit testing with jest and chai (May 2021)

<Card color={'secondary'} style={{ padding: '16px' }}>
  <Error style={{ paddingBottom: '16px' }}>The current endpoint test set up is far from perfect. First tests can't run
    in parallel. Second, even if tests run in sequence, clean up script might interfere with set up of the next test.
    Third, put location tests fail randomly for unknown reason</Error>
  <Text>If you have better idea on how tests should be set up, feel free to pitch to Kike and Kevin. Or you can create a
    Tech Debt story on Jira</Text>
</Card>



### 1. Copy paste an existing test file as template under `packages/api/tests` directory
**Here is a list of tests that can be used as templates**

- fieldCrop.test.js

- crop.test.js

- shift.test.js

- disease.test.js

- expense.test.js

- expense_type.test.js

- fertilizer.test.js

- pesticides.test.js

- price.test.js

- sale.test.js

**You can follow `location.test.js` or `mock.factories.test.js` if you think api will be stable**

These tests are more abstracted. They are difficult to read/debug/modify. You should use previous templates if tests need to cover edge cases.

**A list of test that will be deprecated**

- authorization.test.js

- insightAPI.test.js

** Postgres:**

<img src={locationSchema} />

### How data is stored on the frontend

** Redux store fieldReducer:**

```js
const fieldReducer = {
  fieldReducer: {
    ids: [
      'b33c566e-ad15-11eb-945a-0242ac120002'
    ],
    entities: {
      'b33c566e-ad15-11eb-945a-0242ac120002': {
        farm_id: '9fd12c8a-ad15-11eb-80bb-0242ac120002',
        name: 'Field',
        notes: '',
        location_id: 'b33c566e-ad15-11eb-945a-0242ac120002',
        figure_id: 'b33d349e-ad15-11eb-945a-0242ac120002',
        type: 'field',
        total_area: 66601,
        total_area_unit: 'ha',
        grid_points: [
          {
            lat: 49.26654453351959,
            lng: -123.17612132540896
          },
          {
            lat: 49.26500428835197,
            lng: -123.17689380160525
          },
          {
            lat: 49.26500428835197,
            lng: -123.17187270632937
          },
          {
            lat: 49.26665654947446,
            lng: -123.17075690737917
          }
        ],
        perimeter: 1136,
        perimeter_unit: 'km',
        organic_status: 'Non-Organic',
        station_id: null,
        transition_date: null
      }
    },
    loading: false,
    loaded: true,
    error: null
  }
}
```

### Steps for a backend - frontend story from a data flow perspective
<ul>
  <li><Underlined>Backend jest unit testing</Underlined></li>
  <li><Underlined style={{ color: colors.brown700 }}>Create knex migration to create/modify tables in
    database</Underlined></li>
  <li><Underlined style={{ color: colors.brown700 }}>Create objection models</Underlined></li>
  <li><Underlined style={{ color: colors.brown700 }}>Endpoint and controller</Underlined></li>
  <li><Underlined>Create authorization/validation middlewares</Underlined></li>
  <li><Underlined>Run tests and make sure everything passes</Underlined></li>
  <li><Underlined>Create pure frontend components in storybook</Underlined></li>
  <li><Underlined style={{ color: colors.brown700 }}>res.data normalizer, redux slice, redux selectors to hold and
    access the data</Underlined></li>
  <li><Underlined style={{ color: colors.brown700 }}>Redux saga for get/post/put/patch request</Underlined></li>
  <li><Underlined>Container component to connect saga actions/selector with pure components</Underlined></li>
  <li><Underlined>Connect Route component with container components with react router</Underlined></li>
  <li><Underlined>Menu testing</Underlined></li>
</ul>




